name: Publish specification

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'preprod'
        type: choice
        options:
          - preprod
          - prod

env:
  APIM_ENV: ${{ github.event.inputs.environment || 'preprod' }}

jobs:
  publish-specification:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install Poetry
        run: curl -sSL https://install.python-poetry.org | python3 -

      - name: Install Python and Node dependencies
        run: |
          make install

      - name: Install proxygen-cli
        run: |
          pip install proxygen-cli

      - name: Set up Proxygen credentials
        env:
          PROXYGEN_PRIVATE_KEY: ${{ secrets.PROXYGEN_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.proxygen
          echo "$PROXYGEN_PRIVATE_KEY" > ~/.proxygen/eligibility-signposting-api.pem
          make setup-proxygen-credentials

      - name: Generate specification
        run: |
          make construct-spec APIM_ENV=${{ env.APIM_ENV }}

      - name: Publish ${{ env.APIM_ENV }} spec to Proxygen
        run: |
          if [ "${{ env.APIM_ENV }}" = "preprod" ]; then
            proxygen spec publish build/specification/preprod/eligibility-signposting-api.yaml --uat --no-confirm
          else
            proxygen spec publish build/specification/prod/eligibility-signposting-api.yaml --no-confirm
          fi

